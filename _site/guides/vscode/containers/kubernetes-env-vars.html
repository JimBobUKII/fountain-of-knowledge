<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Kubernetes service environment variables | Fountain of Knowledge </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Kubernetes service environment variables | Fountain of Knowledge ">
    <meta name="generator" content="docfx 2.57.2.0">
    
    <link rel="shortcut icon" href="../../../favicon.ico">
    <link rel="stylesheet" href="../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../styles/main.css">
    <meta property="docfx:navrel" content="../../../toc.html">
    <meta property="docfx:tocrel" content="../../toc.html">
    
    <meta property="docfx:rel" content="../../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="kubernetes-service-environment-variables">Kubernetes service environment variables</h1>

<p>When you communicate with another service in the same Kubernetes cluster, for example with an HTTP request, you typically use the hardcoded service name in the URL for the request, but that won't work in some scenarios with Bridge to Kubernetes. This article describes how to use the Kubernetes service environment variables to specify the connection URL.</p>
<h2 id="avoid-redirection-failures">Avoid redirection failures</h2>
<p>Bridge to Kubernetes reroutes traffic by modifying the host name resolution to redirect network traffic to its own version of the services. The redirection works in most scenarios, but fails in the case where the Bridge to Kubernetes process has restricted privilege, such as when the request originates from a non-elevated user account or when using VS Code Remote SSH. This is because in order to enable the name resolution for redirected services, Bridge to Kubernetes needs to modify the hosts file, but that is not possible when Bridge to Kubernetes runs from a non-elevated user account. To work around this issue, you can write your code to use the Kubernetes service environment variables instead of a hardcoded service name.</p>
<h2 id="environment-variables-table">Environment variables table</h2>
<p>The following table shows the Kubernetes service environment variables that are available from any service in the cluster, for an example service using the TCP protocol on a port. The <em>servicename</em> is the name of the service, converted to uppercase, and with hyphens converted to underscores, so for example, a service named web-api yields an environment variable named WEB_API_SERVICE_HOST.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>servicename</em>_SERVICE_HOST</td>
<td>10.0.0.11</td>
<td>The name of the service host</td>
</tr>
<tr>
<td><em>servicename</em>_SERVICE_PORT</td>
<td>6379</td>
<td>The port for the service</td>
</tr>
<tr>
<td><em>servicename</em>_PORT</td>
<td>tcp://10.0.0.11:6379</td>
<td>The URL with protocol, IP address, and port.</td>
</tr>
<tr>
<td><em>servicename</em>_PORT_<em>portnumber</em>_<em>protocol</em></td>
<td>tcp://10.0.0.11:6379</td>
<td>The URL with protocol, IP address and port.</td>
</tr>
<tr>
<td><em>servicename</em>_PORT_<em>portnumber</em>_<em>protocol</em>_PROTO</td>
<td>tcp</td>
<td>The protocol identifier.</td>
</tr>
<tr>
<td><em>servicename</em>_PORT_<em>portnumber</em>_<em>protocol</em>_PORT</td>
<td>6379</td>
<td>The port number for TCP.</td>
</tr>
<tr>
<td><em>servicename</em>_PORT_<em>portnumber</em>_<em>protocol</em>_ADDR</td>
<td>10.0.0.11</td>
<td>The IP address for TCP.</td>
</tr>
</tbody>
</table>
<p>So if the service is named web-api, the variables are WEB_API_SERVICE_HOST and WEB_API_SERVICE_PORT, and so on. The default environment variables created by Kubernetes are described in the <a href="https://kubernetes.io../concepts/services-networking/service/#environment-variables">Kubernetes documentation</a>. For information about the supported protocols, see <a href="https://kubernetes.io../concepts/services-networking/service/#protocol-support">Supported protocols</a>.</p>
<h2 id="environment-variables-in-source-code">Environment variables in source code</h2>
<p>To enable your services to run in Bridge to Kubernetes without elevated privileges, replace any hardcoded references to the hostname with the environment variable. The following example shows this in a .NET service named mywebapi written in C#:</p>
<pre><code class="lang-csharp">    using var client = new HttpClient();
    var host = Environment.GetEnvironmentVariable(&quot;MYWEBAPI_SERVICE_HOST&quot;);
    var port = Environment.GetEnvironmentVariable(&quot;MYWEBAPI_SERVICE_PORT&quot;);
    var request = new HttpRequestMessage();
    request.RequestUri = new Uri($&quot;http://{host}:{port}/api/data&quot;);
    var response = await client.SendAsync(request);
</code></pre>
<p>An example in Node.js looks like this:</p>
<pre><code class="lang-js">    server.get(&quot;/api/data&quot;, function (req, res) {
        var options = {
            host: process.env.MYWEBAPI_SERVICE_HOST,
            port: process.env.MYWEBAPI_SERVICE_PORT,
            path: '/api/data',
            method: 'GET'
        };
        var req = http.request(options, function(response) {
            res.setHeader('Content-Type', 'application/json');
            var responseString = '';
            //another chunk of data has been received, so append it to `responseString`
            response.on('data', function (chunk) {
                responseString += chunk;
            });
            response.on('end', function () {
                res.send(responseString);
            });
        });

        req.on('error', function(e) {
            console.log('problem with request: ' + e.message);
          });

          req.end();
    });
</code></pre>
<p>To update your code to use the environment variables, look for any occurrences of the hostname and update to use the value obtained from the environment variable <em>servicename</em>_SERVICE_HOST.</p>
<p>Even if you usually don't specify the port used by the target service when calling it, you will need to use the <em>servicename</em>_SERVICE_PORT environment variable. Specifying the port allows Bridge to Kubernetes to avoid the conflicts happening when a specific port isn't available on the development machine. You don't need to change the port on which your service listens for this to work: you just need to make sure that when your service calls other services, it calls them using both the <em>servicename</em>_SERVICE_HOST and <em>servicename</em>_SERVICE_PORT environment variables.</p>
<p>If you reuse the same code elsewhere in the cluster, that is fine, because these environment variables are available in every pod in the cluster. If you reuse the same code outside of a Kubernetes cluster, you either have to set up the equivalent environment variables or modify the code appropriately for the new platform or hosting service.</p>
<h2 id="set-vs-code-to-use-kubernetes-service-environment-variables">Set VS Code to use Kubernetes service environment variables</h2>
<p>If you're using VS Code with a remote computer or running VS Code as a normal user, you also need to configure VS Code to use the Kubernetes service environment variables. Open tasks.json, find the task with the label <code>bridge-to-kubernetes.service</code> and add the property <code>usekubernetesServiceEnvironmentVariables</code> with the value <code>true</code>, as shown in the following code:</p>
<pre><code class="lang-json">    &quot;tasks&quot;: [
        {
            &quot;label&quot;: &quot;bridge-to-kubernetes.service&quot;,
            &quot;type&quot;: &quot;bridge-to-kubernetes.service&quot;,
            &quot;service&quot;: &quot;bikes&quot;,
            &quot;ports&quot;: [
                3000
            ],
            &quot;useKubernetesServiceEnvironmentVariables&quot;: true
        }
    ]
</code></pre>
<p>The setting is only needed if you are running VS Code as a normal user, or if you are using a remote session, but if you have modified your code as described in this article, there is no harm in setting this property.</p>
<h2 id="next-steps">Next steps</h2>
<p>Read more about Bridge to Kubernetes configuration at <a href="https://docs.microsoft.com/visualstudio/containers/configure-bridge-to-kubernetes">How to configure Bridge to Kubernetes</a>.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            &#0169; 2021 Jason Rose
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
